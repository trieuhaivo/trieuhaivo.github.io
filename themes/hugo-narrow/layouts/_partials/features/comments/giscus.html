{{/* Giscus 评论系统组件

  基于 GitHub Discussions 的评论系统

  @context {page} . 当前文章页面对象
  @param {string} id 评论容器的唯一 ID
*/}}

{{ $id := .id | default "giscus-comments" }}
{{ $config := .Site.Params.comments.giscus }}

{{ if $config.repo }}
  <div id="{{ $id }}" class="giscus-container">
    <script
      src="https://giscus.app/client.js"
      data-repo="{{ $config.repo }}"
      data-repo-id="{{ $config.repoId }}"
      data-category="{{ $config.category | default "General" }}"
      data-category-id="{{ $config.categoryId }}"
      data-mapping="{{ $config.mapping | default "pathname" }}"
      data-strict="{{ $config.strict | default "0" }}"
      data-reactions-enabled="{{ $config.reactionsEnabled | default "1" }}"
      data-emit-metadata="{{ $config.emitMetadata | default "0" }}"
      data-input-position="{{ $config.inputPosition | default "bottom" }}"
      data-theme="{{ $config.theme | default "preferred_color_scheme" }}"
      data-lang="{{ $config.lang | default .Site.Language.LanguageCode | default "zh-CN" }}"
      data-loading="lazy"
      crossorigin="anonymous"
      async></script>
  </div>

  {{/* 主题切换支持 */}}
  <script>
    (function() {
      'use strict';

      // 获取当前主题的函数
      function getCurrentTheme() {
        // 检查 localStorage 中的主题设置
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          return savedTheme;
        }
        
        // 检查系统主题偏好
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        
        // 检查 HTML 元素的 class
        if (document.documentElement.classList.contains('dark')) {
          return 'dark';
        }
        
        // 默认返回 light
        return 'light';
      }

      // 更新 giscus 主题的函数
      function updateGiscusTheme() {
        const iframe = document.querySelector('#{{ $id }} iframe.giscus-frame');
        if (!iframe) return;

        const theme = getCurrentTheme();
        
        // 发送主题更新消息
        iframe.contentWindow.postMessage({
          giscus: {
            setConfig: {
              theme: theme
            }
          }
        }, 'https://giscus.app');
      }

      // 初始化 giscus 主题的函数
      function initializeGiscusTheme() {
        // 等待 iframe 加载完成
        const checkIframe = setInterval(() => {
          const iframe = document.querySelector('#{{ $id }} iframe.giscus-frame');
          if (iframe) {
            clearInterval(checkIframe);
            
            // 确保 iframe 内容已加载
            iframe.addEventListener('load', () => {
              updateGiscusTheme();
            });
            
            // 如果 iframe 已经加载完成，直接更新主题
            if (iframe.contentWindow && iframe.contentWindow.postMessage) {
              updateGiscusTheme();
            }
          }
        }, 100);

        // 设置超时，避免无限循环
        setTimeout(() => {
          clearInterval(checkIframe);
        }, 5000);
      }

      // 监听主题切换事件
      document.addEventListener('themeChanged', updateGiscusTheme);

      // 监听 localStorage 变化（主题设置变化）
      window.addEventListener('storage', (e) => {
        if (e.key === 'theme') {
          updateGiscusTheme();
        }
      });

      // 监听系统主题变化
      if (window.matchMedia) {
        const darkModeQuery = window.matchMedia('(prefers-color-scheme: dark)');
        darkModeQuery.addEventListener('change', () => {
          updateGiscusTheme();
        });
      }

      // 监听 DOM 变化（用于检测主题切换）
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            updateGiscusTheme();
          }
        });
      });

      observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class']
      });

      // 监听页面可见性变化
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          updateGiscusTheme();
        }
      });

      // 初始化
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeGiscusTheme);
      } else {
        initializeGiscusTheme();
      }

      // 监听 Hugo 页面切换事件（如果是 SPA 模式）
      window.addEventListener('popstate', () => {
        setTimeout(initializeGiscusTheme, 100);
      });
    })();
  </script>
{{ else }}
  <div id="{{ $id }}" class="py-8 text-center">
    <div
      class="bg-muted/50 mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full">
      {{ partial "features/icon.html" (dict "name" "github" "size" "lg" "ariaLabel" "") }}
    </div>
    <h3 class="text-foreground mb-2 text-lg font-medium">
      {{ i18n "comments.giscus_not_configured" | default "Giscus 未配置" }}
    </h3>
    <p class="text-muted-foreground text-sm">
      {{ i18n "comments.giscus_config_desc" | default "请在站点配置中设置 GitHub 仓库信息" }}
    </p>
  </div>
{{ end }}
